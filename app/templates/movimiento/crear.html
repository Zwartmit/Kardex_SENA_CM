{% extends 'layout.html' %}
{% load widget_tweaks %}
{% block contenido %}
<form method="post" action=".">
    <div class="card card-default">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-plus"></i>
                {{ titulo }}
            </h3>
        </div>
        <div class="card-body">
            {% csrf_token %}
            <div class="form-group">
                <label for="{{ form.elemento.id_for_label }}">{{ form.elemento.label }}</label>
                {{ form.elemento|add_class:'form-control'|attr:'autocomplete:off' }}
            </div>

            <div id="additional-fields">
                <!-- Primer conjunto de campos -->
                <div class="form-group d-flex align-items-center">
                    <label>Elemento:</label>
                    <select name="elemento[]" class="form-control" placeholder="Seleccione un elemento">
                        <option value="">Seleccione un elemento</option>
                        {% for elemento in elementos %}
                            <option value="{{ elemento.id }}">{{ elemento.item }}</option>
                        {% endfor %}
                    </select>
                    
                    <label>Cantidad:</label>
                    <input type="number" name="cantidad[]" class="form-control" placeholder="Cantidad">

                    <button type="button" class="btn btn-danger btn-sm ml-2 remove-field">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </div>
                <!-- Fin del primer conjunto de campos -->
            </div>
            <button type="button" id="add-field" class="btn btn-secondary mt-2" style="background-color: #034231;">
                <i class="fas fa-plus"></i> Agregar otro elemento
            </button>
            
            <!-- Otros campos del formulario -->
            {% for field in form.visible_fields %}
                {% if field.name != "elemento" %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        {{ field|add_class:'form-control'|attr:'autocomplete:off' }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="card-footer">
        <button class="btn btn-primary btn-flat">
            <i class="fas fa-plus"></i> Guardar
        </button>
        <a href="{{ listar_url }}" class="btn btn-danger btn-flat">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<script>
    // Almacena las opciones de elemento en un arreglo de objetos
    const elementos = [
        {% for elemento in elementos %}
        { id: {{ elemento.id }}, nombre: "{{ elemento.item }}" },
        {% endfor %}
    ];

    document.getElementById('add-field').addEventListener('click', function() {
        const container = document.getElementById('additional-fields');
        const newFieldGroup = document.createElement('div');
        newFieldGroup.className = 'form-group d-flex align-items-center'; // Para alinear los campos

        // Crea el select para el nuevo elemento
        let selectHTML = '<label>Elemento:</label>';
        selectHTML += '<select name="elemento[]" class="form-control" placeholder="Seleccione un elemento">';
        selectHTML += '<option value="">Seleccione un elemento</option>'; // Opción por defecto

        // Agrega las opciones del select
        elementos.forEach(function(elemento) {
            selectHTML += `<option value="${elemento.id}">${elemento.nombre}</option>`;
        });

        selectHTML += '</select>';

        // Crea otros campos
        const cantidadHTML = `
            <label>Cantidad:</label>
            <input type="number" name="cantidad[]" class="form-control" placeholder="Cantidad">
        `;

        // Botón para eliminar el elemento
        const deleteButtonHTML = `
            <button type="button" class="btn btn-danger btn-sm ml-2 remove-field">
                <i class="fas fa-trash-alt"></i> Eliminar
            </button>
        `;

        newFieldGroup.innerHTML = selectHTML + cantidadHTML + deleteButtonHTML;
        container.appendChild(newFieldGroup);

        // Agregar evento para eliminar el grupo de campos
        newFieldGroup.querySelector('.remove-field').addEventListener('click', function() {
            container.removeChild(newFieldGroup);
        });
    });

    // Agregar evento para el botón de eliminar del primer grupo de campos
    const initialRemoveButton = document.querySelector('.remove-field');
    initialRemoveButton.addEventListener('click', function() {
        const fieldGroup = initialRemoveButton.closest('.form-group');
        fieldGroup.parentNode.removeChild(fieldGroup);
    });
</script>

<script>
    {% if form.errors %}
        var errors = '';
        {% for field in form %}
            {% for error in field.errors %}
                errors += '{{ error }}';
            {% endfor %}
        {% endfor %}

        Swal.fire({
            title: 'Error',
            text: 'Ya existe un movimiento con este nombre.',
            icon: 'error',
            confirmButtonText: 'Aceptar',
            confirmButtonColor: '#034231'
        });
    {% elif request.GET.created %}
        Swal.fire({
            title: 'Éxito',
            text: 'Movimiento registrado con éxito.',
            icon: 'success',
            confirmButtonText: 'Aceptar',
            confirmButtonColor: '#034231'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "{% url 'app:movimiento_lista' %}";
            }
        });
    {% elif request.GET.updated %}
        Swal.fire({
            title: 'Éxito',
            text: 'Movimiento editado con éxito.',
            icon: 'success',
            confirmButtonText: 'Aceptar',
            confirmButtonColor: '#034231'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "{% url 'app:movimiento_lista' %}";
            }
        });
    {% endif %}
</script>
{% endblock %}
