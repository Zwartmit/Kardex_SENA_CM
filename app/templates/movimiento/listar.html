{% extends 'listar.html' %}
{% load static %}

{% block columnas %}
<tr>
    <th scope="col" style="width: auto; align-content: center; text-align: center;">id</th>
    <th scope="col" style="width: auto; align-content: center; text-align: center;">Ficha</th>
    <th scope="col" style="width: auto; align-content: center; text-align: center;">Programa de formación</th>
    <th scope="col" style="width: auto; align-content: center; text-align: center;">Vocero</th>
    <th scope="col" style="width: auto; align-content: center; text-align: center;">Instructor</th>
    <th scope="col" style="width: 100px; align-content: center; text-align: center;">Fecha</th>
    <th scope="col" style="width: auto; align-content: center; text-align: center;">Detalles</th>
</tr>
<tr>
    <th style="width: auto; text-align: center; align-content: center;">
        <input type="text" placeholder="Filtrar" class="filter-input" style="width: 100px;" />
    </th>
    <th style="width: auto; text-align: center; align-content: center;">
        <input type="text" placeholder="Filtrar" class="filter-input" style="width: 100px;" />
    </th>
    <th style="width: auto; text-align: center; align-content: center;">
        <input type="text" placeholder="Filtrar" class="filter-input" style="width: 100px;" />
    </th>
    <th style="width: auto; text-align: center; align-content: center;">
        <input type="text" placeholder="Filtrar" class="filter-input" style="width: 100px;" />
    </th>
    <th style="width: auto; text-align: center; align-content: center;">
        <input type="text" placeholder="Filtrar" class="filter-input" style="width: 100px;" />
    </th>
    <th style="width: auto; text-align: left; align-content: center;">
        <div class="filter-container">
        </div>
    </th>
    <th style="width: auto; text-align: center; align-content: center;"></th>
</tr>
{% endblock %}

{% block filas %}
{% for p in object_list %}
<tr>
    <td style="width: auto; text-align: center; align-content: center;">{{ p.id }}</td>
    <td style="width: auto; text-align: center; align-content: center;">{{ p.num_ficha }}</td>
    <td style="width: auto; text-align: center; align-content: center;">{{ p.programa_formacion }}</td>
    <td style="width: auto; text-align: center; align-content: center;">{{ p.aprendiz }}</td>
    <td style="width: auto; text-align: center; align-content: center;">{{ p.instructor }}</td>
    <td style="width: auto; text-align: center; align-content: center;">{{ p.fecha|date:"Y-m-d H:i:s" }}</td>
    <td style="width: auto; text-align: center; align-content: center;">
        <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#modalElementos{{ p.id }}"><i class="fas fa-search"></i></button>
        <div class="modal fade" id="modalElementos{{ p.id }}" tabindex="-1" role="dialog" aria-labelledby="modalLabel{{ p.id }}" aria-hidden="true">
            <div class="modal-dialog" style="max-width: 90%; width: auto;">
                <div class="modal-content" style="border-radius: 18px;">
                    <div class="modal-header"
                        style="display: grid; justify-content: center; background: #094b39; color: #ffffff; border-radius: 15px;  filter: drop-shadow(0 0 6px #000000);">
                        <h5 class="modal-title" id="modalLabel{{ p.id }}"><b>Detalles del movimiento (</b>ID: #{{ p.id }}<b>)</b></h5>
                    </div>
                    <div class="modal-body">
                        <div class="table-container" style="display: flex; justify-content: center; align-items: center;">
                            <table class="table table-bordered" id="tabla-datos" style="width: auto; max-width: auto; margin: auto;">
                                <tr>
                                    <th rowspan="2" class="logo" style="text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">
                                        <img src="{% static 'img/logoSENA_N.jpg' %}" style="height: 80px; width: 80px;" alt="Logo SENA" class="logo-image img-fluid">
                                    </th>
                                    <td colspan="5" class="header" style="text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">
                                        <strong style="font-size: 25px;">SISTEMA INTEGRADO DE GESTIÓN</strong><br>
                                        <b>Formato: </b>Entrega de materiales de formación al aprendiz (SENA, Centro Minero)<br>
                                        <b>Proceso: </b>Gestión de formación profesional integral<br>
                                        <b>Procedimiento: </b>Ejecución de la formación profesional integral
                                    </td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Programa de formación:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.programa_formacion }}</span></td>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Nº de ficha:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.num_ficha }}</span></td>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Fecha de inicio:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.fecha_inicio_programa }}</span></td>
                                </tr>
                                <tr>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Nº Aprendices:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.num_aprendices }}</span></td>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Vocero:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.aprendiz }}</span></td>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Instructor:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.instructor }}</span></td>
                                </tr>
                                <tr>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Nº de contrato:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.num_contrato }}</span></td>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Fecha de entrega:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.fecha }}</span></td>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Dependencia:</th>
                                    <td style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.dependencia }}</span> </td>
                                </tr>
                                <tr>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Proyectos asociados:</th>
                                    <td colspan="5" style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.proyecto }}</span></td>
                                </tr>
                                <th colspan="6" style="border: 0.5px solid #000000"></th>
                                <tr>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Ítem</th>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Descripción del elemento</th>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Cantidad recibida</th>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Cantidad contratada</th>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Saldo pendiente de entrega</th>
                                    <th style="width: auto; text-align: center; align-content: center; background-color: #e8e8e8; border: 0.5px solid #000000">Observaciones</th>
                                </tr>
                                {% for elemento in p.elementos.all %}
                                <tr>
                                    <td style="text-align: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ elemento.item }}</span></td>
                                    <td style="text-align: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ elemento.descripcion }}</span></td>
                                    <td style="text-align: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ elemento.cantidad_recibida }}</span></td>
                                    <td style="text-align: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ elemento.cantidad_contratada }}</span></td>
                                    <td style="text-align: center; background: #ffffff; border: 0.5px solid #000000"><span>$ {{ elemento.saldo }}</span></td>
                                    <td style="text-align: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ elemento.observaciones }}</span></td>
                                </tr>
                                {% endfor %}
                                <th colspan="6" style="border: 0.5px solid #000000"></th>
                                <tr>
                                    <th style="width: auto; text-align: center; background-color: #e8e8e8; border: 0.5px solid #000000"><b>Observaciones generales:</b></th>
                                    <td colspan="5" style="width: auto; text-align: center; align-content: center; background: #ffffff; border: 0.5px solid #000000"><span>{{ p.obs_general }}</span></td>
                                </tr>
                                <tr>
                                    <th colspan="6" style="border: 0.5px solid #000000"></th>
                                </tr>
                                <td colspan="6" style="text-align: center; background-color: #e8e8e8; border: 0.5px solid #000000; font-size: 18px"><b>FIRMAS</b></td>
                                <tr>
                                    <td colspan="2" style="text-align: center; border: 0.5px solid #000000; height: 90px;">
                                    </td>
                                    <td colspan="2" style="text-align: center; border: 0.5px solid #000000; height: 90px;">
                                    </td>
                                    <td colspan="2" style="text-align: center; border: 0.5px solid #000000; height: 90px;">
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="text-align: center; background-color: #e8e8e8; border: 0.5px solid #000000"><b>Coordinador academico</b></td>
                                    <td colspan="2" style="text-align: center; background-color: #e8e8e8; border: 0.5px solid #000000"><b>Instructor</b></td>
                                    <td colspan="2" style="text-align: center; background-color: #e8e8e8; border: 0.5px solid #000000"><b>Vocero</b></td>
                                </tr>
                            </table>                          
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="generatePdfButton"><i class="fas fa-file-pdf"></i>Generar PDF</button>
                        <button type="button" class="btn btn-danger" style="filter: drop-shadow(0 0 3px #000000);" data-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </th>
</tr>
{% endfor %}
{% endblock %}

{% block javascript %}
<script type="application/javascript">
    $(document).ready(function () {
        var table = $("#tabla").DataTable({
            responsive: true,
            initComplete: function () {
                var api = this.api();
                var columnNames = ['id', 'Elementos', 'Descripción', 'Fecha', 'Proyecto', 'Ficha', 'Opciones'];
                var excludedColumns = [1, 6];

                api.columns().every(function (index) {
                    var column = this;
                    var filterContainer = $('#tabla thead tr:eq(1) th').eq(index).find('.filter-container');

                    if (!excludedColumns.includes(index)) {
                        if (index === 5) {  // Cambié de 3 a 5 para que coincida con la columna de "Fecha"
                            var startDateInput = $('<input type="date" placeholder="Desde">').appendTo(filterContainer);
                            var endDateInput = $('<input type="date" placeholder="Hasta">').appendTo(filterContainer);

                            startDateInput.add(endDateInput).on('change', function () {
                                var startDate = startDateInput.val();
                                var endDate = endDateInput.val();

                                var start = startDate ? new Date(startDate + "T00:00:00") : null;
                                var end = endDate ? new Date(endDate + "T23:59:59") : null;

                                $.fn.dataTable.ext.search = [];

                                $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                                    var fechaVenta = data[5]; // Corregí el índice de la fecha
                                    var fecha = new Date(fechaVenta); // Convierte la fecha en formato Date

                                    if ((start && fecha < start) || (end && fecha > end)) {
                                        return false;
                                    }
                                    return true;
                                });

                                table.draw();
                            });
                        }
                    }
                });
            }
        });
    });
</script>
{% endblock %}